<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–Ω–±–∞–Ω: –ö—Å–µ–Ω–∏—è & –ö–ª–∞—É</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding: 20px; min-height: 100vh; }
        h1 { text-align: center; margin-bottom: 30px; color: #333; font-size: 24px; }
        .board { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 20px; }
        .column { background: #ebecf0; border-radius: 12px; width: 300px; min-width: 300px; padding: 15px; display: flex; flex-direction: column; max-height: calc(100vh - 150px); }
        .column-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #ddd; }
        .column-title { font-weight: 600; font-size: 14px; color: #333; }
        .column-count { background: #fff; padding: 2px 8px; border-radius: 12px; font-size: 12px; color: #666; }
        .tasks { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; min-height: 100px; }
        .task { background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: grab; transition: transform 0.2s, box-shadow 0.2s; position: relative; }
        .task:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .task.dragging { opacity: 0.5; cursor: grabbing; }
        .task-title { font-size: 14px; color: #333; margin-bottom: 8px; line-height: 1.4; word-wrap: break-word; }
        .task-dates { font-size: 11px; color: #888; margin-bottom: 6px; }
        .task-dates .created { color: #666; }
        .task-dates .completed { color: #388e3c; font-weight: 500; }
        .task-history-btn { font-size: 10px; color: #1976d2; cursor: pointer; text-decoration: underline; margin-top: 4px; display: inline-block; }
        .task-history-btn:hover { color: #0d47a1; }
        .task-meta { display: flex; gap: 6px; flex-wrap: wrap; }
        .tag { font-size: 10px; padding: 3px 8px; border-radius: 12px; font-weight: 500; }
        .tag-high { background: #ffebee; color: #c62828; }
        .tag-medium { background: #fff3e0; color: #ef6c00; }
        .tag-low { background: #e8f5e9; color: #2e7d32; }
        .tag-automation { background: #e1f5fe; color: #0277bd; }
        .tag-research { background: #f3e5f5; color: #7b1fa2; }
        .tag-integration { background: #e0f2f1; color: #00695c; }
        .tag-content { background: #fff8e1; color: #f57f17; }
        .add-task { margin-top: 10px; padding: 10px; background: transparent; border: 2px dashed #ccc; border-radius: 8px; color: #666; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .add-task:hover { border-color: #999; color: #333; background: rgba(0,0,0,0.02); }
        .column.drag-over { background: #d4edda; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 450px; max-height: 90vh; overflow-y: auto; }
        .modal-title { font-size: 18px; margin-bottom: 15px; color: #333; }
        .modal input, .modal select, .modal textarea { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; font-family: inherit; }
        .modal textarea { min-height: 80px; resize: vertical; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background: #1976d2; color: #fff; }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .delete-btn { position: absolute; top: 8px; right: 8px; color: #999; cursor: pointer; font-size: 18px; line-height: 1; padding: 0 4px; }
        .delete-btn:hover { color: #c62828; }
        .column-ideas { border-top: 4px solid #7c4dff; }
        .column-todo { border-top: 4px solid #9e9e9e; }
        .column-progress { border-top: 4px solid #1976d2; }
        .column-review { border-top: 4px solid #f57c00; }
        .column-done { border-top: 4px solid #388e3c; }
        .history-modal .history-item { padding: 8px 0; border-bottom: 1px solid #eee; font-size: 13px; }
        .history-modal .history-item:last-child { border-bottom: none; }
        .history-modal .history-date { color: #888; font-size: 11px; }
        .history-modal .history-from-to { color: #333; }
        .history-modal .history-reason { color: #666; font-style: italic; margin-top: 4px; }
        .move-reason { font-size: 12px; color: #555; margin-top: 8px; padding: 8px; background: #f5f5f5; border-radius: 6px; border-left: 3px solid #1976d2; }
        @media (max-width: 768px) {
            body { padding: 10px; }
            h1 { font-size: 20px; margin-bottom: 20px; }
            .column { width: 280px; min-width: 280px; padding: 12px; }
            .board { gap: 10px; }
        }
    </style>
</head>
<body>
    <h1>üìã –ö–∞–Ω–±–∞–Ω: –ö—Å–µ–Ω–∏—è & –ö–ª–∞—É</h1>
    <div class="board">
        <div class="column column-ideas" data-column="ideas">
            <div class="column-header">
                <span class="column-title">üí° –ò–¥–µ–∏ / –ù–∞ –ø–æ—Ç–æ–º</span>
                <span class="column-count">0</span>
            </div>
            <div class="tasks"></div>
            <button class="add-task" onclick="openModal('ideas')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div class="column column-todo" data-column="todo">
            <div class="column-header">
                <span class="column-title">üìã –í –ø–ª–∞–Ω–µ</span>
                <span class="column-count">0</span>
            </div>
            <div class="tasks"></div>
            <button class="add-task" onclick="openModal('todo')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div class="column column-progress" data-column="progress">
            <div class="column-header">
                <span class="column-title">üîß –ö–ª–∞—É –¥–µ–ª–∞–µ—Ç</span>
                <span class="column-count">0</span>
            </div>
            <div class="tasks"></div>
            <button class="add-task" onclick="openModal('progress')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div class="column column-review" data-column="review">
            <div class="column-header">
                <span class="column-title">üëÄ –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</span>
                <span class="column-count">0</span>
            </div>
            <div class="tasks"></div>
            <button class="add-task" onclick="openModal('review')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div class="column column-done" data-column="done">
            <div class="column-header">
                <span class="column-title">‚úÖ –ì–æ—Ç–æ–≤–æ</span>
                <span class="column-count">0</span>
            </div>
            <div class="tasks"></div>
            <button class="add-task" onclick="openModal('done')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <h3 class="modal-title">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h3>
            <input type="text" id="taskTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏">
            <select id="taskPriority">
                <option value="high">üî¥ –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                <option value="medium" selected>üü° –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                <option value="low">üü¢ –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
            </select>
            <select id="taskType">
                <option value="automation">ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è</option>
                <option value="research">üîç –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ</option>
                <option value="integration">üîå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è</option>
                <option value="content">üìù –ö–æ–Ω—Ç–µ–Ω—Ç</option>
                <option value="task" selected>üìã –î—Ä—É–≥–æ–µ</option>
            </select>
            <textarea id="taskDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="addTask()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è –ø—Ä–∏—á–∏–Ω—ã –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è -->
    <div class="modal" id="moveModal">
        <div class="modal-content">
            <h3 class="modal-title">–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏</h3>
            <p style="margin-bottom: 12px; font-size: 14px; color: #666;">
                –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∏–∑: <strong id="moveFrom">-</strong> ‚Üí <strong id="moveTo">-</strong>
            </p>
            <textarea id="moveReason" placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" style="min-height: 60px;"></textarea>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="cancelMove()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="confirmMove()">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ -->
    <div class="modal history-modal" id="historyModal">
        <div class="modal-content">
            <h3 class="modal-title">üìú –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π</h3>
            <div id="historyContent" style="max-height: 300px; overflow-y: auto;"></div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeHistoryModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        let currentColumn = 'todo';
        let draggedTask = null;
        let taskIdCounter = Date.now();
        let pendingMove = null;
        
        // –ù–∞—á–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏ —Å –¥–∞—Ç–∞–º–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∏ –∏—Å—Ç–æ—Ä–∏–µ–π
        const defaultTasks = [
            { 
                id: 'task-1', 
                title: '–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–±–∞–Ω-–¥–æ—Å–∫—É –≤ Telegram Mini App', 
                priority: 'high', 
                type: 'automation', 
                desc: '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å GitHub Pages', 
                column: 'done',
                createdAt: '2025-02-10T10:00:00.000Z',
                completedAt: '2025-02-12T15:30:00.000Z',
                history: [
                    { from: 'ideas', to: 'todo', date: '2025-02-10T10:05:00.000Z', reason: '' },
                    { from: 'todo', to: 'progress', date: '2025-02-11T09:00:00.000Z', reason: '–ù–∞—á–∞–ª–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏' },
                    { from: 'progress', to: 'done', date: '2025-02-12T15:30:00.000Z', reason: '–ì–æ—Ç–æ–≤–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ' }
                ]
            },
            { 
                id: 'task-2', 
                title: '–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è Exchange', 
                priority: 'high', 
                type: 'integration', 
                desc: 'Python —Å–∫—Ä–∏–ø—Ç –¥–ª—è EWS', 
                column: 'done',
                createdAt: '2025-02-08T14:00:00.000Z',
                completedAt: '2025-02-11T16:00:00.000Z',
                history: [
                    { from: 'todo', to: 'progress', date: '2025-02-09T10:00:00.000Z', reason: '' },
                    { from: 'progress', to: 'done', date: '2025-02-11T16:00:00.000Z', reason: '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ' }
                ]
            },
            { 
                id: 'task-3', 
                title: '–£—Ç—Ä–µ–Ω–Ω–∏–π –¥–∞–π–¥–∂–µ—Å—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—è (cron)', 
                priority: 'medium', 
                type: 'automation', 
                desc: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram', 
                column: 'done',
                createdAt: '2025-02-09T09:00:00.000Z',
                completedAt: '2025-02-13T08:00:00.000Z',
                history: [
                    { from: 'todo', to: 'progress', date: '2025-02-10T11:00:00.000Z', reason: '' },
                    { from: 'progress', to: 'review', date: '2025-02-12T17:00:00.000Z', reason: '–¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã cron' },
                    { from: 'review', to: 'done', date: '2025-02-13T08:00:00.000Z', reason: '–†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ' }
                ]
            },
            { 
                id: 'task-4', 
                title: '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Bitrix24 –¥–ª—è –∑–∞–¥–∞—á', 
                priority: 'medium', 
                type: 'integration', 
                desc: '–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á –∏–∑ API', 
                column: 'ideas',
                createdAt: '2025-02-14T11:00:00.000Z',
                history: []
            },
            { 
                id: 'task-5', 
                title: '–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –≤ –¥–∞–π–¥–∂–µ—Å—Ç–µ', 
                priority: 'high', 
                type: 'automation', 
                desc: '–ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤ —É—Ç—Ä–µ–Ω–Ω–µ–º –¥–∞–π–¥–∂–µ—Å—Ç–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è', 
                column: 'done',
                createdAt: '2025-02-15T10:00:00.000Z',
                completedAt: '2025-02-16T14:30:00.000Z',
                history: [
                    { from: 'todo', to: 'progress', date: '2025-02-15T11:00:00.000Z', reason: '–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å UTC' },
                    { from: 'progress', to: 'done', date: '2025-02-16T14:30:00.000Z', reason: '–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ GMT+3' }
                ]
            },
            { 
                id: 'task-6', 
                title: '–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á –ö–ª–∞—É', 
                priority: 'medium', 
                type: 'automation', 
                desc: '–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ö–ª–∞—É —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –∑–∞–¥–∞—á–∏ –≤ –∫–∞–Ω–±–∞–Ω', 
                column: 'done',
                createdAt: '2025-02-14T16:00:00.000Z',
                completedAt: '2025-02-17T05:00:00.000Z',
                history: [
                    { from: 'ideas', to: 'todo', date: '2025-02-15T09:00:00.000Z', reason: '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è —Ñ–∏—á–∞' },
                    { from: 'todo', to: 'progress', date: '2025-02-16T10:00:00.000Z', reason: '–ù–∞—á–∞–ª–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏' },
                    { from: 'progress', to: 'done', date: '2025-02-17T05:00:00.000Z', reason: '–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω' }
                ]
            }
        ];
        
        const columnNames = {
            'ideas': 'üí° –ò–¥–µ–∏',
            'todo': 'üìã –í –ø–ª–∞–Ω–µ',
            'progress': 'üîß –ö–ª–∞—É –¥–µ–ª–∞–µ—Ç',
            'review': 'üëÄ –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ',
            'done': '‚úÖ –ì–æ—Ç–æ–≤–æ'
        };
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á –∏–∑ localStorage –∏–ª–∏ –Ω–∞—á–∞–ª—å–Ω—ã—Ö
        function loadTasks() {
            const saved = localStorage.getItem('kanban-tasks');
            if (saved) {
                try {
                    const tasks = JSON.parse(saved);
                    tasks.forEach(task => {
                        if (task && task.id) {
                            taskIdCounter = Math.max(taskIdCounter, parseInt(task.id.split('-')[1]) || 0);
                            createTaskElement(task);
                        }
                    });
                } catch(e) { console.error('Error loading tasks:', e); }
            } else {
                // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ - –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏
                defaultTasks.forEach(task => createTaskElement(task));
                saveTasks();
            }
            updateCounts();
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á
        function saveTasks() {
            const tasks = [];
            document.querySelectorAll('.task').forEach(taskEl => {
                const task = {
                    id: taskEl.dataset.id,
                    title: taskEl.querySelector('.task-title').textContent,
                    priority: taskEl.dataset.priority,
                    type: taskEl.dataset.type,
                    desc: taskEl.dataset.desc || '',
                    column: taskEl.closest('.column').dataset.column,
                    createdAt: taskEl.dataset.createdAt,
                    completedAt: taskEl.dataset.completedAt || null,
                    history: JSON.parse(taskEl.dataset.history || '[]')
                };
                tasks.push(task);
            });
            localStorage.setItem('kanban-tasks', JSON.stringify(tasks));
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        function formatDateTime(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
        }
        
        function openModal(column) {
            currentColumn = column;
            document.getElementById('modal').classList.add('active');
            document.getElementById('taskTitle').focus();
        }
        
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDesc').value = '';
        }
        
        function openMoveModal(from, to) {
            pendingMove = { from, to };
            document.getElementById('moveFrom').textContent = columnNames[from];
            document.getElementById('moveTo').textContent = columnNames[to];
            document.getElementById('moveReason').value = '';
            document.getElementById('moveModal').classList.add('active');
            document.getElementById('moveReason').focus();
        }
        
        function cancelMove() {
            pendingMove = null;
            document.getElementById('moveModal').classList.remove('active');
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–¥–∞—á—É –Ω–∞ –∏—Å—Ö–æ–¥–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
            if (draggedTask) {
                const fromColumn = document.querySelector(`[data-column="${draggedTask.dataset.lastColumn}"]`);
                if (fromColumn) {
                    fromColumn.querySelector('.tasks').appendChild(draggedTask);
                }
                draggedTask = null;
            }
        }
        
        function confirmMove() {
            if (!pendingMove || !draggedTask) return;
            
            const reason = document.getElementById('moveReason').value.trim();
            const history = JSON.parse(draggedTask.dataset.history || '[]');
            
            history.push({
                from: pendingMove.from,
                to: pendingMove.to,
                date: new Date().toISOString(),
                reason: reason
            });
            
            draggedTask.dataset.history = JSON.stringify(history);
            
            // –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ done, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            if (pendingMove.to === 'done' && !draggedTask.dataset.completedAt) {
                draggedTask.dataset.completedAt = new Date().toISOString();
            }
            
            // –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ—â–∞–µ–º –∏–∑ done, —É–¥–∞–ª—è–µ–º –¥–∞—Ç—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            if (pendingMove.to !== 'done') {
                draggedTask.dataset.completedAt = '';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞—Ç
            updateTaskDates(draggedTask);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏—á–∏–Ω—É –≤ –∑–∞–¥–∞—á–µ
            updateMoveReason(draggedTask, reason);
            
            pendingMove = null;
            document.getElementById('moveModal').classList.remove('active');
            draggedTask = null;
            saveTasks();
            updateCounts();
        }
        
        function updateTaskDates(taskEl) {
            const createdAt = taskEl.dataset.createdAt;
            const completedAt = taskEl.dataset.completedAt;
            const datesEl = taskEl.querySelector('.task-dates');
            
            let html = `<span class="created">üìÖ –°–æ–∑–¥–∞–Ω–æ: ${formatDate(createdAt)}</span>`;
            if (completedAt) {
                html += ` | <span class="completed">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${formatDate(completedAt)}</span>`;
            }
            datesEl.innerHTML = html;
        }
        
        function updateMoveReason(taskEl, reason) {
            let reasonEl = taskEl.querySelector('.move-reason');
            if (reason) {
                if (!reasonEl) {
                    reasonEl = document.createElement('div');
                    reasonEl.className = 'move-reason';
                    taskEl.appendChild(reasonEl);
                }
                reasonEl.textContent = `üí¨ ${reason}`;
            } else if (reasonEl) {
                reasonEl.remove();
            }
        }
        
        function addTask() {
            const title = document.getElementById('taskTitle').value.trim();
            if (!title) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏');
                return;
            }
            
            const task = {
                id: 'task-' + (++taskIdCounter),
                title: title,
                priority: document.getElementById('taskPriority').value,
                type: document.getElementById('taskType').value,
                desc: document.getElementById('taskDesc').value.trim(),
                column: currentColumn,
                createdAt: new Date().toISOString(),
                history: []
            };
            
            createTaskElement(task);
            saveTasks();
            updateCounts();
            closeModal();
        }
        
        function createTaskElement(task) {
            const taskEl = document.createElement('div');
            taskEl.className = 'task';
            taskEl.draggable = true;
            taskEl.dataset.id = task.id;
            taskEl.dataset.priority = task.priority;
            taskEl.dataset.type = task.type;
            taskEl.dataset.desc = task.desc || '';
            taskEl.dataset.createdAt = task.createdAt || new Date().toISOString();
            taskEl.dataset.completedAt = task.completedAt || '';
            taskEl.dataset.history = JSON.stringify(task.history || []);
            taskEl.dataset.lastColumn = task.column;
            
            const priorityClass = 'tag-' + task.priority;
            const typeClasses = {
                'automation': 'tag-automation',
                'research': 'tag-research', 
                'integration': 'tag-integration',
                'content': 'tag-content',
                'task': ''
            };
            const typeLabels = {
                'automation': '–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è',
                'research': '–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ',
                'integration': '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è', 
                'content': '–ö–æ–Ω—Ç–µ–Ω—Ç',
                'task': ''
            };
            const typeClass = typeClasses[task.type] || '';
            const typeLabel = typeLabels[task.type] || '';
            
            const createdAt = task.createdAt || new Date().toISOString();
            const completedAt = task.completedAt;
            
            let datesHtml = `<span class="created">üìÖ –°–æ–∑–¥–∞–Ω–æ: ${formatDate(createdAt)}</span>`;
            if (completedAt) {
                datesHtml += ` | <span class="completed">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${formatDate(completedAt)}</span>`;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –ø—Ä–∏—á–∏–Ω—É –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
            const history = task.history || [];
            const lastMove = history[history.length - 1];
            let reasonHtml = '';
            if (lastMove && lastMove.reason) {
                reasonHtml = `<div class="move-reason">üí¨ ${escapeHtml(lastMove.reason)}</div>`;
            }
            
            taskEl.innerHTML = `
                <span class="delete-btn" onclick="deleteTask(this)">&times;</span>
                <div class="task-title">${escapeHtml(task.title)}</div>
                <div class="task-dates">${datesHtml}</div>
                <div class="task-meta">
                    <span class="tag ${priorityClass}">${getPriorityLabel(task.priority)}</span>
                    ${typeLabel ? `<span class="tag ${typeClass}">${typeLabel}</span>` : ''}
                </div>
                ${history.length > 0 ? `<span class="task-history-btn" onclick="showHistory('${task.id}')">üìú –ò—Å—Ç–æ—Ä–∏—è (${history.length})</span>` : ''}
                ${reasonHtml}
            `;
            
            // Drag events
            taskEl.addEventListener('dragstart', (e) => {
                draggedTask = taskEl;
                taskEl.dataset.lastColumn = taskEl.closest('.column').dataset.column;
                taskEl.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });
            
            taskEl.addEventListener('dragend', () => {
                taskEl.classList.remove('dragging');
                document.querySelectorAll('.column').forEach(col => {
                    col.classList.remove('drag-over');
                });
            });
            
            const column = document.querySelector(`[data-column="${task.column}"]`);
            if (column) {
                column.querySelector('.tasks').appendChild(taskEl);
            }
        }
        
        function showHistory(taskId) {
            const taskEl = document.querySelector(`[data-id="${taskId}"]`);
            if (!taskEl) return;
            
            const history = JSON.parse(taskEl.dataset.history || '[]');
            const content = document.getElementById('historyContent');
            
            if (history.length === 0) {
                content.innerHTML = '<p style="color: #888; text-align: center;">–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π –ø—É—Å—Ç–∞</p>';
            } else {
                content.innerHTML = history.map(h => `
                    <div class="history-item">
                        <div class="history-from-to">${columnNames[h.from]} ‚Üí ${columnNames[h.to]}</div>
                        <div class="history-date">${formatDateTime(h.date)}</div>
                        ${h.reason ? `<div class="history-reason">üí¨ ${escapeHtml(h.reason)}</div>` : ''}
                    </div>
                `).join('');
            }
            
            document.getElementById('historyModal').classList.add('active');
        }
        
        function closeHistoryModal() {
            document.getElementById('historyModal').classList.remove('active');
        }
        
        function deleteTask(btn) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) {
                btn.closest('.task').remove();
                saveTasks();
                updateCounts();
            }
        }
        
        function updateCounts() {
            document.querySelectorAll('.column').forEach(column => {
                const count = column.querySelectorAll('.task').length;
                column.querySelector('.column-count').textContent = count;
            });
        }
        
        function getPriorityLabel(priority) {
            const labels = { high: '–í—ã—Å–æ–∫–∏–π', medium: '–°—Ä–µ–¥–Ω–∏–π', low: '–ù–∏–∑–∫–∏–π' };
            return labels[priority] || priority;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Drop zones
        document.querySelectorAll('.column').forEach(column => {
            column.addEventListener('dragover', (e) => {
                e.preventDefault();
                column.classList.add('drag-over');
            });
            
            column.addEventListener('dragleave', () => {
                column.classList.remove('drag-over');
            });
            
            column.addEventListener('drop', (e) => {
                e.preventDefault();
                column.classList.remove('drag-over');
                if (draggedTask) {
                    const fromColumn = draggedTask.dataset.lastColumn;
                    const toColumn = column.dataset.column;
                    
                    if (fromColumn !== toColumn) {
                        column.querySelector('.tasks').appendChild(draggedTask);
                        openMoveModal(fromColumn, toColumn);
                    } else {
                        draggedTask = null;
                    }
                }
            });
        });
        
        // Enter –≤ –º–æ–¥–∞–ª–∫–µ
        document.getElementById('taskTitle').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addTask();
        });
        
        document.getElementById('moveReason').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                confirmMove();
            }
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–æ–∫ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ
        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') closeModal();
        });
        
        document.getElementById('moveModal').addEventListener('click', (e) => {
            if (e.target.id === 'moveModal') cancelMove();
        });
        
        document.getElementById('historyModal').addEventListener('click', (e) => {
            if (e.target.id === 'historyModal') closeHistoryModal();
        });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadTasks();
    </script>
</body>
</html>
